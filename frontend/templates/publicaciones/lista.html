{% extends 'base.html' %}

{% block title %}Publicaciones - Red Social Deportistas{% endblock %}

{% block extra_css %}
<style>
  .publicacion-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    padding: 1.5rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .publicacion-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .publicacion-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
  }

  .publicacion-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), #667eea);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin-right: 1rem;
  }

  .publicacion-info h3 {
    margin: 0;
    color: #333;
    font-size: 1.1rem;
  }

  .publicacion-info small {
    color: #666;
    font-size: 0.9rem;
  }

  .publicacion-contenido {
    margin: 1rem 0;
    line-height: 1.6;
    color: #444;
  }

  .publicacion-imagen {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: 10px;
    margin: 1rem 0;
  }

  .publicacion-stats {
    display: flex;
    gap: 2rem;
    padding: 1rem 0;
    border-top: 1px solid #e0e0e0;
    border-bottom: 1px solid #e0e0e0;
    margin: 1rem 0;
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
  }

  .publicacion-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  .btn-accion {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-accion:hover {
    transform: translateY(-1px);
  }

  .entrenamiento-controls {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    min-width: 280px;
  }

  .cronometro {
    font-size: 2rem;
    font-weight: bold;
    text-align: center;
    margin: 1rem 0;
    font-family: 'Courier New', monospace;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .deporte-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }

  .deporte-btn {
    padding: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }

  .deporte-btn:hover {
    border-color: var(--primary-color);
    background: #f8f9ff;
    transform: translateY(-2px);
  }

  .deporte-btn.selected {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: white;
  }

  .publicacion-entrenamiento {
    border-left: 4px solid #28a745;
    background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
    position: relative;
    overflow: hidden;
  }

  .publicacion-entrenamiento::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #28a745, #20c997);
    clip-path: polygon(100% 0, 0 0, 100% 100%);
  }

  .publicacion-entrenamiento::after {
    content: 'üèÉ‚Äç‚ôÇÔ∏è';
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 1.2rem;
    z-index: 1;
  }

  .entrenamiento-badge {
    display: inline-block;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
  }

  .publicacion-entrenamiento .publicacion-contenido {
    font-family: 'Courier New', monospace;
    background: rgba(255, 255, 255, 0.7);
    padding: 1rem;
    border-radius: 10px;
    border: 1px solid rgba(40, 167, 69, 0.2);
    white-space: pre-line;
  }

  .crear-publicacion-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), #667eea);
    color: white;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    z-index: 999;
  }

  .crear-publicacion-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  }

  .entrenamiento-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    padding: 0.75rem;
    margin: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .entrenamiento-card h3 {
    text-align: center;
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    font-weight: 600;
  }

  .timer-display {
    display: flex;
    justify-content: center;
    gap: 0.4rem;
    margin: 0.5rem 0;
  }

  .timer-digit {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    padding: 0.3rem 0.2rem;
    text-align: center;
    min-width: 35px;
    color: #333;
  }

  .timer-digit .number {
    font-size: 1rem;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    display: block;
    line-height: 1;
    color: #333;
  }

  .timer-digit .label {
    font-size: 0.55rem;
    margin-top: 0.1rem;
    color: #666;
  }

  .timer-separator {
    font-size: 1rem;
    font-weight: bold;
    align-self: center;
    opacity: 0.9;
    color: white;
  }

  .entrenamiento-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.4rem;
    margin: 0.5rem 0 0 0;
  }

  .entrenamiento-stats .stat-item {
    background: rgba(255, 255, 255, 0.9);
    padding: 0.4rem;
    border-radius: 4px;
    text-align: center;
    color: #333;
  }

  .entrenamiento-stats .stat-label {
    font-size: 0.65rem;
    margin-bottom: 0.1rem;
    color: #666;
    font-weight: 600;
  }

  .entrenamiento-stats .stat-value {
    font-size: 0.8rem;
    font-weight: bold;
    color: #333;
  }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h1><i class="fas fa-newspaper"></i> Feed de Publicaciones</h1>
  
  {% if user.is_authenticated %}
  <div style="display: flex; gap: 1rem;">
    <a href="{% url 'crear_publicacion' %}" class="btn">
      <i class="fas fa-plus"></i> Nueva Publicaci√≥n
    </a>
    
    {% if not sesion_activa %}
    <button onclick="abrirModalEntrenamiento()" class="btn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
      <i class="fas fa-play"></i> Iniciar Entrenamiento
    </button>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Widget de entrenamiento activo -->
{% if sesion_activa %}
<div class="entrenamiento-controls">
  <div style="text-align: center; margin-bottom: 1rem;">
    <h3 style="margin: 0;">{{ sesion_activa.get_deporte_display }}</h3>
    <small>Entrenamiento en progreso</small>
  </div>
  
  <div class="cronometro" id="cronometro">00:00:00</div>
  
  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
    {% if sesion_activa.estado == 'activo' %}
    <button onclick="pausarEntrenamiento()" class="btn btn-secondary" style="flex: 1;">
      <i class="fas fa-pause"></i> Pausar
    </button>
    {% else %}
    <button onclick="reanudarEntrenamiento()" class="btn" style="flex: 1; background: #28a745;">
      <i class="fas fa-play"></i> Reanudar
    </button>
    {% endif %}
    
    <button onclick="finalizarEntrenamiento()" class="btn" style="flex: 1; background: #007bff;">
      <i class="fas fa-stop"></i> Finalizar
    </button>
    
    <button onclick="cancelarEntrenamiento()" class="btn btn-danger" style="flex: 1;">
      <i class="fas fa-times"></i> Cancelar
    </button>
  </div>
</div>
{% endif %}

<!-- Lista de publicaciones -->
{% if publicaciones %}
  {% for publicacion in publicaciones %}
  <div class="publicacion-card {% if publicacion.tipo == 'entrenamiento' %}publicacion-entrenamiento{% endif %}">
    {% if publicacion.tipo == 'entrenamiento' %}
    <div class="entrenamiento-badge">
      <i class="fas fa-dumbbell"></i> Sesi√≥n de Entrenamiento
    </div>
    {% endif %}

    <div class="publicacion-header">
      <div class="publicacion-avatar">
        {{ publicacion.autor.first_name.0|default:publicacion.autor.username.0|upper }}
      </div>
      <div class="publicacion-info">
        <h3>
          <a href="#" style="text-decoration: none; color: inherit;">
            {{ publicacion.autor.get_full_name|default:publicacion.autor.username }}
          </a>
        </h3>
        <small>{{ publicacion.fecha_creacion|date:"d M Y, H:i" }}</small>
      </div>
    </div>

    <div class="publicacion-contenido">
      {% if publicacion.tipo == 'entrenamiento' %}
        <!-- Renderizar publicaci√≥n de entrenamiento -->
        <div class="entrenamiento-card">
          <h3>ENTRENAMIENTO COMPLETADO</h3>
          
          {% if publicacion.timer_data.horas %}
            <div class="timer-display">
              <div class="timer-digit">
                <span class="number">{{ publicacion.timer_data.horas }}</span>
                <div class="label">HRS</div>
              </div>
              <div class="timer-separator">:</div>
              <div class="timer-digit">
                <span class="number">{{ publicacion.timer_data.minutos }}</span>
                <div class="label">MIN</div>
              </div>
              <div class="timer-separator">:</div>
              <div class="timer-digit">
                <span class="number">{{ publicacion.timer_data.segundos }}</span>
                <div class="label">SEC</div>
              </div>
            </div>
          {% endif %}
          
          <div class="entrenamiento-stats">
            {% if publicacion.timer_data.deporte %}
              <div class="stat-item">
                <div class="stat-label">DEPORTE</div>
                <div class="stat-value">{{ publicacion.timer_data.deporte }}</div>
              </div>
            {% endif %}
            {% if publicacion.timer_data.distancia %}
              <div class="stat-item">
                <div class="stat-label">DISTANCIA</div>
                <div class="stat-value">{{ publicacion.timer_data.distancia }}</div>
              </div>
            {% endif %}
            {% if publicacion.timer_data.calorias %}
              <div class="stat-item">
                <div class="stat-label">CALORIAS</div>
                <div class="stat-value">{{ publicacion.timer_data.calorias }}</div>
              </div>
            {% endif %}
            {% if publicacion.timer_data.fecha %}
              <div class="stat-item">
                <div class="stat-label">FECHA</div>
                <div class="stat-value">{{ publicacion.timer_data.fecha }}</div>
              </div>
            {% endif %}
          </div>
          
          {% if publicacion.timer_data.notas %}
            <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
              <div style="font-weight: bold; margin-bottom: 0.5rem;">NOTAS:</div>
              <div style="opacity: 0.9;">{{ publicacion.timer_data.notas }}</div>
            </div>
          {% endif %}
        </div>
      {% else %}
        <!-- Renderizar publicaci√≥n normal -->
        {{ publicacion.contenido|truncatewords:30 }}
      {% endif %}
    </div>

    {% if publicacion.imagen %}
    <img src="{{ publicacion.imagen.url }}" alt="Imagen de publicaci√≥n" class="publicacion-imagen">
    {% endif %}

    <div class="publicacion-stats">
      <div class="stat-item">
        <i class="fas fa-heart" style="color: #ff6b6b;"></i>
        <strong>{{ publicacion.likes_count }}</strong> likes
      </div>
      <div class="stat-item">
        <i class="fas fa-comment" style="color: var(--primary-color);"></i>
        <strong>{{ publicacion.comentarios_count }}</strong> comentarios
      </div>
    </div>

    <div class="publicacion-actions">
      <button onclick="toggleLike({{ publicacion.id }})" class="btn-accion" style="background: {% if publicacion.id in user_likes %}#ff6b6b{% else %}#f8f9fa{% endif %}; color: {% if publicacion.id in user_likes %}white{% else %}#666{% endif %};">
        <i class="fas fa-heart"></i>
        {% if publicacion.id in user_likes %}Te gusta{% else %}Me gusta{% endif %}
      </button>

      <a href="{% url 'detalle_publicacion' publicacion.id %}" class="btn-accion" style="background: var(--primary-color); color: white;">
        <i class="fas fa-eye"></i>
        Ver m√°s
      </a>
    </div>
  </div>
  {% endfor %}
{% else %}
<div class="publicacion-card">
  <h3><i class="fas fa-info-circle"></i> No hay publicaciones a√∫n</h3>
  <p>S√© el primero en compartir algo con la comunidad.</p>
  {% if user.is_authenticated %}
  <a href="{% url 'crear_publicacion' %}" class="btn">
    <i class="fas fa-plus"></i> Crear Primera Publicaci√≥n
  </a>
  {% endif %}
</div>
{% endif %}

{% if user.is_authenticated %}
<a href="{% url 'crear_publicacion' %}" class="crear-publicacion-btn" title="Nueva Publicaci√≥n">
  <i class="fas fa-plus"></i>
</a>
{% endif %}

<!-- Modal para iniciar entrenamiento -->
<div id="modalEntrenamiento" class="modal">
  <div class="modal-content">
    <h2><i class="fas fa-play"></i> Iniciar Entrenamiento</h2>
    
    <p>Selecciona el tipo de deporte que vas a practicar:</p>
    
    <div class="deporte-grid">
      {% for deporte_id, deporte_nombre in deportes_populares %}
      <button class="deporte-btn" onclick="seleccionarDeporte('{{ deporte_id }}', this)">
        {{ deporte_nombre }}
      </button>
      {% endfor %}
    </div>
    
    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
      <button onclick="cerrarModalEntrenamiento()" class="btn btn-secondary" style="flex: 1;">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button id="btnIniciar" onclick="iniciarEntrenamiento()" class="btn" style="flex: 1;" disabled>
        <i class="fas fa-play"></i> Iniciar
      </button>
    </div>
  </div>
</div>

<!-- Modal para finalizar entrenamiento -->
<div id="modalFinalizar" class="modal">
  <div class="modal-content">
    <h2><i class="fas fa-stop"></i> Finalizar Entrenamiento</h2>
    
    <p>Agrega detalles de tu sesi√≥n (opcional):</p>
    
    <div class="form-group">
      <label for="distancia">Distancia (km):</label>
      <input type="number" id="distancia" step="0.1" min="0" class="form-control">
    </div>
    
    <div class="form-group">
      <label for="calorias">Calor√≠as quemadas:</label>
      <input type="number" id="calorias" min="0" class="form-control">
    </div>
    
    <div class="form-group">
      <label for="notas">Notas:</label>
      <textarea id="notas" rows="3" class="form-control" placeholder="¬øC√≥mo te sentiste? ¬øAlguna observaci√≥n?"></textarea>
    </div>
    
    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
      <button onclick="cerrarModalFinalizar()" class="btn btn-secondary" style="flex: 1;">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button onclick="confirmarFinalizacion()" class="btn" style="flex: 1; background: #007bff;">
        <i class="fas fa-check"></i> Finalizar y Publicar
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let deporteSeleccionado = null;
let cronometroInterval = null;
let tiempoInicio = null;

// Funciones del modal de entrenamiento
function abrirModalEntrenamiento() {
    console.log('Abriendo modal de entrenamiento'); // Debug
    const modal = document.getElementById('modalEntrenamiento');
    if (modal) {
        modal.style.display = 'block';
        console.log('Modal abierto correctamente');
    } else {
        console.error('Modal no encontrado');
    }
}

function cerrarModalEntrenamiento() {
    const modal = document.getElementById('modalEntrenamiento');
    if (modal) {
        modal.style.display = 'none';
        deporteSeleccionado = null;
        const btnIniciar = document.getElementById('btnIniciar');
        if (btnIniciar) {
            btnIniciar.disabled = true;
        }
        // Limpiar selecciones
        document.querySelectorAll('.deporte-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        console.log('Modal cerrado');
    }
}

function seleccionarDeporte(deporteId, elemento) {
    console.log('Deporte seleccionado:', deporteId); // Debug
    // Limpiar selecciones anteriores
    document.querySelectorAll('.deporte-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Seleccionar nuevo deporte
    elemento.classList.add('selected');
    deporteSeleccionado = deporteId;
    const btnIniciar = document.getElementById('btnIniciar');
    if (btnIniciar) {
        btnIniciar.disabled = false;
        console.log('Bot√≥n iniciar habilitado');
    }
}

function iniciarEntrenamiento() {
    console.log('Iniciando entrenamiento con deporte:', deporteSeleccionado); // Debug
    if (!deporteSeleccionado) {
        alert('Por favor selecciona un deporte');
        return;
    }
    
    fetch('{% url "iniciar_entrenamiento" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `deporte=${deporteSeleccionado}`
    })
    .then(response => response.json())
    .then(data => {
        console.log('Respuesta del servidor:', data); // Debug
        if (data.success) {
            cerrarModalEntrenamiento();
            location.reload(); // Recargar para mostrar el widget
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al iniciar entrenamiento');
    });
}

// Funciones de control del entrenamiento
function pausarEntrenamiento() {
    controlarEntrenamiento('pausar');
}

function reanudarEntrenamiento() {
    controlarEntrenamiento('reanudar');
}

function cancelarEntrenamiento() {
    if (confirm('¬øEst√°s seguro de que quieres cancelar el entrenamiento?')) {
        controlarEntrenamiento('cancelar');
    }
}

function finalizarEntrenamiento() {
    document.getElementById('modalFinalizar').style.display = 'block';
}

function cerrarModalFinalizar() {
    document.getElementById('modalFinalizar').style.display = 'none';
}

function confirmarFinalizacion() {
    const distancia = document.getElementById('distancia').value;
    const calorias = document.getElementById('calorias').value;
    const notas = document.getElementById('notas').value;
    
    let formData = 'accion=finalizar';
    if (distancia) formData += `&distancia=${distancia}`;
    if (calorias) formData += `&calorias=${calorias}`;
    if (notas) formData += `&notas=${encodeURIComponent(notas)}`;
    
    fetch('{% url "controlar_entrenamiento" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cerrarModalFinalizar();
            alert('¬°Entrenamiento completado y publicado!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al finalizar entrenamiento');
    });
}

function controlarEntrenamiento(accion) {
    fetch('{% url "controlar_entrenamiento" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `accion=${accion}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al controlar entrenamiento');
    });
}

// Cron√≥metro
{% if sesion_activa %}
function actualizarCronometro() {
    fetch('{% url "tiempo_entrenamiento" %}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const segundos = data.duracion_segundos;
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);
            const segs = segundos % 60;
            
            const cronometroElement = document.getElementById('cronometro');
            if (cronometroElement) {
                cronometroElement.textContent = 
                    `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segs.toString().padStart(2, '0')}`;
            }
        }
    })
    .catch(error => console.error('Error actualizando cron√≥metro:', error));
}

// Actualizar cron√≥metro cada segundo
cronometroInterval = setInterval(actualizarCronometro, 1000);
actualizarCronometro(); // Llamada inicial
{% endif %}

// Funci√≥n para likes
function toggleLike(publicacionId) {
    fetch(`/publicaciones/${publicacionId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => response.json())
    .then(data => {
        location.reload(); // Recargar para actualizar el estado
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Cerrar modales al hacer clic fuera
window.onclick = function(event) {
    const modalEntrenamiento = document.getElementById('modalEntrenamiento');
    const modalFinalizar = document.getElementById('modalFinalizar');
    
    if (event.target === modalEntrenamiento) {
        cerrarModalEntrenamiento();
    }
    if (event.target === modalFinalizar) {
        cerrarModalFinalizar();
    }
}

// Debug: Verificar que el bot√≥n existe
document.addEventListener('DOMContentLoaded', function() {
    const botonIniciar = document.querySelector('button[onclick="abrirModalEntrenamiento()"]');
    console.log('Bot√≥n iniciar entrenamiento encontrado:', botonIniciar);
    
    const modal = document.getElementById('modalEntrenamiento');
    console.log('Modal encontrado:', modal);
    
    const deporteBtns = document.querySelectorAll('.deporte-btn');
    console.log('Botones de deporte encontrados:', deporteBtns.length);
});
</script>
{% endblock %}







