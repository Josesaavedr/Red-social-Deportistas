{% extends 'base.html' %}

{% block title %}Publicaciones - Red Social Deportistas{% endblock %}

{% block extra_css %}
<style>
  .feed-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .feed-card {
    background: white;
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0;
  }
  .feed-media {
    height: 200px;
    background-size: cover;
    background-position: center;
  }
  .feed-body {
    padding: 1.5rem;
  }
  .feed-author {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .feed-avatar {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.3rem;
  }
  .feed-meta {
    color: #8d99ae;
    font-size: 0.9rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .feed-stats {
    display: flex;
    gap: 1.5rem;
    margin-top: 1.25rem;
    color: #555;
    font-weight: 600;
  }
  .feed-actions {
    margin-top: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .tag-pill {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    background: rgba(102,126,234,.12);
    color: var(--primary-color);
    padding: .35rem .85rem;
    border-radius: 999px;
    font-size: 0.85rem;
  }
  .own-label {
    font-size: 0.8rem;
    color: #fff;
    background: var(--success-color);
    padding: 0.15rem 0.7rem;
    border-radius: 999px;
  }
  .training-card {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .training-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .training-panel {
    border: 1px dashed var(--primary-color);
    border-radius: 14px;
    padding: 1.25rem;
    background: rgba(102,126,234,0.05);
  }
  .timer-display {
    font-size: 2.5rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 1rem;
  }
  .training-form {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }
  .training-form textarea {
    grid-column: 1 / -1;
    min-height: 90px;
  }
  .training-alert {
    margin-top: 1rem;
    display: none;
  }
</style>
{% endblock %}

{% block content %}
{% set liked_posts = liked_posts or [] %}
<div class="card">
  <h2 style="margin-bottom: 0.5rem;">
    <i class="fas fa-newspaper"></i> Feed de deportistas
  </h2>
  <p style="color: #666;">
    Historias creadas por toda la comunidad. Tus publicaciones aparecerán marcadas como propias.
  </p>

  <div class="btn-group" style="margin-top: 1rem;">
    <a href="{{ url_for('crear_publicacion') }}" class="btn">
      <i class="fas fa-plus"></i> Compartir logro
    </a>
    <a href="{{ url_for('feed_publicaciones') }}" class="btn btn-secondary">
      <i class="fas fa-stream"></i> Ver en modo resumen
    </a>
  </div>
</div>

<div class="card training-card">
  <div class="training-header">
    <div>
      <h3><i class="fas fa-stopwatch"></i> Modo entrenamiento</h3>
      <p style="color:#666; max-width: 560px;">
        Activa un cronómetro en vivo, describe tu sesión y publicaremos automáticamente el resultado para que tu comunidad conozca tu progreso.
      </p>
    </div>
    <button id="start-training-btn" class="btn">
      <i class="fas fa-play"></i> Iniciar entrenamiento
    </button>
  </div>
  <div id="training-panel" class="training-panel" style="display:none;">
    <div class="timer-display" id="training-timer">00:00</div>
    <div class="btn-group" style="justify-content: center; flex-wrap: wrap; gap: .75rem;">
      <button id="pause-training-btn" class="btn btn-secondary" type="button">
        <i class="fas fa-pause"></i> Pausar
      </button>
      <button id="finish-training-btn" class="btn btn-success" type="button">
        <i class="fas fa-flag-checkered"></i> Terminar
      </button>
      <button id="cancel-training-btn" class="btn btn-danger" type="button">
        <i class="fas fa-times"></i> Cancelar
      </button>
    </div>
    <div class="training-form" style="margin-top: 1rem;">
      <div>
        <label for="training-sport"><i class="fas fa-dumbbell"></i> Deporte</label>
        <select id="training-sport" class="form-control">
          <option value="Running">Running</option>
          <option value="Ciclismo">Ciclismo</option>
          <option value="Natación">Natación</option>
          <option value="Cross Training">Cross Training</option>
          <option value="Yoga">Yoga</option>
          <option value="Otro">Otro</option>
        </select>
      </div>
      <div>
        <label for="training-feel"><i class="fas fa-heartbeat"></i> ¿Cómo te sentiste?</label>
        <input type="text" id="training-feel" class="form-control" placeholder="Motivado, cansado, etc." />
      </div>
      <div>
        <label for="training-desc"><i class="fas fa-align-left"></i> Describe tu sesión</label>
        <textarea id="training-desc" class="form-control" placeholder="Ej. Intervalos de 400m, trabajo de core..."></textarea>
      </div>
    </div>
  </div>
  <div id="training-message" class="alert training-alert"></div>
</div>

{% set posts = publicaciones or [] %}

{% if posts %}
  <div class="feed-grid" style="margin-top: 1.5rem;">
    {% for publicacion in posts %}
      {% set autor = publicacion.autor or 'Deportista' %}
      {% set inicial = autor[:1] %}
      {% set fecha = publicacion.fecha or '' %}
      {% set fecha_legible = fecha.replace('T', ' ') %}
      <article class="feed-card">
        {% if publicacion.imagen %}
        <div class="feed-media" style="background-image: url('{{ publicacion.imagen }}');"></div>
        {% endif %}
        <div class="feed-body">
          <div class="feed-author">
            <div class="feed-avatar">
              {{ inicial }}
            </div>
            <div>
              <strong style="font-size: 1.1rem;">{{ autor }}</strong>
              <div class="feed-meta">
                <span><i class="fas fa-running"></i> {{ publicacion.deporte or 'Deporte' }}</span>
                <span><i class="fas fa-clock"></i> {{ fecha_legible }}</span>
                {% if publicacion.es_mio %}
                <span class="own-label"><i class="fas fa-star"></i> Mi publicación</span>
                {% endif %}
              </div>
            </div>
          </div>
          <h3 style="margin: 0 0 .75rem 0;">{{ publicacion.titulo or 'Publicación sin título' }}</h3>
          <p style="color: #444; line-height: 1.6;">{{ publicacion.contenido or 'Contenido no disponible aún.' }}</p>
          {% if publicacion.duracion %}
          <div class="tag-pill" style="margin-top: .5rem;">
            <i class="fas fa-stopwatch"></i> Duración {{ publicacion.duracion }}
          </div>
          {% endif %}
          <div class="feed-actions">
            <div class="feed-stats">
              <span>
                <i class="fas fa-heart"></i>
                {% if publicacion.id %}
                  <span id="like-count-{{ publicacion.id }}">{{ publicacion.likes or 0 }}</span>
                {% else %}
                  {{ publicacion.likes or 0 }}
                {% endif %}
                likes
              </span>
              <span><i class="fas fa-comment"></i> {{ publicacion.comentarios or 0 }} comentarios</span>
            </div>
            {% if publicacion.id %}
            <button
              type="button"
              class="btn btn-secondary btn-like"
              data-publication-id="{{ publicacion.id }}"
              data-like-url="{{ url_for('like_publicacion', pub_id=publicacion.id) }}"
              {% if liked_posts and publicacion.id in liked_posts %}disabled{% endif %}
            >
              <i class="fas fa-thumbs-up"></i>
              {% if liked_posts and publicacion.id in liked_posts %}
                ¡Te gusta!
              {% else %}
                Me gusta
              {% endif %}
            </button>
            {% endif %}
          </div>
        </div>
      </article>
    {% endfor %}
  </div>
{% else %}
  <p style="margin-top: 1.5rem; color: #999;">Todavía no hay publicaciones disponibles. ¡Crea la primera!</p>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const startBtn = document.getElementById('start-training-btn');
  const panel = document.getElementById('training-panel');
  const timerDisplay = document.getElementById('training-timer');
  const pauseBtn = document.getElementById('pause-training-btn');
  const finishBtn = document.getElementById('finish-training-btn');
  const cancelBtn = document.getElementById('cancel-training-btn');
  const descInput = document.getElementById('training-desc');
  const sportInput = document.getElementById('training-sport');
  const feelInput = document.getElementById('training-feel');
  const messageEl = document.getElementById('training-message');
  const endpoint = "{{ url_for('crear_publicacion_entrenamiento') }}";

  const state = {
    seconds: 0,
    intervalId: null,
    isRunning: false,
    isPaused: false,
  };

  function formatTime(totalSeconds) {
    const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
    const seconds = (totalSeconds % 60).toString().padStart(2, '0');
    const hours = Math.floor(totalSeconds / 3600);
    if (hours) {
      const mins = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
      return `${hours.toString().padStart(2, '0')}:${mins}:${seconds}`;
    }
    return `${minutes}:${seconds}`;
  }

  function updateTimerDisplay() {
    timerDisplay.textContent = formatTime(state.seconds);
  }

  function tick() {
    state.seconds += 1;
    updateTimerDisplay();
  }

  function showMessage(text, type = 'info') {
    if (!messageEl) return;
    messageEl.style.display = 'block';
    messageEl.className = `alert training-alert alert-${type}`;
    messageEl.textContent = text;
  }

  function clearMessage() {
    if (!messageEl) return;
    messageEl.style.display = 'none';
    messageEl.textContent = '';
  }

  function resetTraining(hidePanel = true, wipeMessage = false) {
    clearInterval(state.intervalId);
    state.seconds = 0;
    state.intervalId = null;
    state.isRunning = false;
    state.isPaused = false;
    updateTimerDisplay();
    if (hidePanel) {
      panel.style.display = 'none';
      startBtn.disabled = false;
    }
    pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pausar';
    descInput.value = '';
    feelInput.value = '';
    if (wipeMessage) {
      clearMessage();
    }
  }

  startBtn?.addEventListener('click', () => {
    panel.style.display = 'block';
    startBtn.disabled = true;
    resetTraining(false, true);
      state.isRunning = true;
      state.intervalId = setInterval(tick, 1000);
  });

  pauseBtn?.addEventListener('click', () => {
    if (!state.isRunning) return;
    if (state.isPaused) {
      state.intervalId = setInterval(tick, 1000);
      pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pausar';
      state.isPaused = false;
      showMessage('Entrenamiento reanudado.', 'info');
    } else {
      clearInterval(state.intervalId);
      state.intervalId = null;
      pauseBtn.innerHTML = '<i class="fas fa-play"></i> Reanudar';
      state.isPaused = true;
      showMessage('Entrenamiento en pausa.', 'warning');
    }
  });

  cancelBtn?.addEventListener('click', () => {
    resetTraining(true, true);
  });

  finishBtn?.addEventListener('click', async () => {
    if (state.seconds <= 0) {
      showMessage('Inicia el temporizador antes de terminar.', 'danger');
      return;
    }

    const descripcion = descInput.value.trim();
    const deporte = sportInput.value.trim();
    const sensacion = feelInput.value.trim();

    if (!descripcion || !sensacion) {
      showMessage('Describe tu entrenamiento y cómo te sentiste para publicarlo.', 'danger');
      return;
    }

    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          duracion: state.seconds,
          descripcion,
          deporte,
          sensacion,
        }),
      });

      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.message || 'No se pudo guardar el entrenamiento.');
      }

      showMessage('Entrenamiento registrado, creando publicación...', 'success');
      setTimeout(() => window.location.reload(), 1000);
      resetTraining(true, false);
    } catch (error) {
      showMessage(error.message, 'danger');
      resetTraining(true, false);
    }
  });

  document.querySelectorAll('.btn-like').forEach((btn) => {
    btn.addEventListener('click', async () => {
      if (btn.disabled) return;
      const url = btn.dataset.likeUrl;
      const pubId = btn.dataset.publicationId;
      try {
        const response = await fetch(url, { method: 'POST' });
        const data = await response.json();
        if (!response.ok || !data.success) {
          throw new Error(data.message || 'No se pudo registrar el me gusta.');
        }
        const counter = document.getElementById(`like-count-${pubId}`);
        if (counter) {
          counter.textContent = data.likes;
        }
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-thumbs-up"></i> ¡Te gusta!';
      } catch (error) {
        alert(error.message || 'Ocurrió un error al registrar tu me gusta.');
      }
    });
  });
});
</script>
{% endblock %}
